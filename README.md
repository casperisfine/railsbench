# railsbench

Based on [headius/pgrailsbench](https://github.com/headius/pgrailsbench),
but on Rails 5.2 and with database seeds.

## What's this?

This application is generated by following commands:

```
rails new railsbench --database=postgresql
rails g scaffold post title:string body:text published:boolean
```

## Setup

Make sure config/database.yml works for your local PostgreSQL.

```bash
sudo apt install postgresql

sudo -u postgres psql
postgres=$ create role k0kubun superuser;

# Add `local all k0kubun trust`
sudo vi /etc/postgresql/10/main/pg_hba.conf

sudo systemctl restart postgresql
```

Populate database and assets for `RAILS_ENV=production`.

```bash
gem install bundler -v 1.17.2
bundle install
bundle exec rake db:create db:migrate db:seed RAILS_ENV=production
bundle exec rake assets:precompile RAILS_ENV=production
```

## Run

```bash
# CRuby
bundle exec puma -e production --workers=4 --threads=1 --preload

# JRuby
bundle exec puma -e production --threads=4
```

You can see posts on `localhost:3000/posts`.

Assets are not shown properly with `-e production` but it's intentional because
Rails assumes we delegate assets distribution to a reverse proxy on production by default.

If you want to see the actual apprecation behavior, do the setup with `RAILS_ENV=development`
and try `puma -e development`.

## Benchmark

Install Apache Bench with `sudo apt install apache2-utils`. Then:

```bash
# HTML posts#index
ab -c 4 -n 10000 localhost:3000/posts

# JSON posts#index
ab -c 4 -n 10000 localhost:3000/posts.json

# HTML posts#show
ab -c 4 -n 10000 localhost:3000/posts/1

# JSON posts#show
ab -c 4 -n 10000 localhost:3000/posts/1.json
```

## License

MIT License
